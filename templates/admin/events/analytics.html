{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    .analytics-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    
    .stat-change {
        font-size: 14px;
        margin-top: 5px;
    }
    
    .stat-change.positive {
        color: #28a745;
    }
    
    .stat-change.negative {
        color: #dc3545;
    }
    
    .chart-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 18px;
        font-weight: 600;
    }
    
    .chart-wrapper {
        position: relative;
        height: 400px;
    }
    
    .recent-milestones {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .milestone-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .milestone-item:last-child {
        border-bottom: none;
    }
    
    .milestone-title {
        font-weight: 600;
        color: #333;
    }
    
    .milestone-time {
        color: #666;
        font-size: 12px;
    }
    
    .date-range-selector {
        margin-bottom: 20px;
        text-align: right;
    }
    
    .date-range-selector select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
    }
    
    .fast-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 20px;
    }
    
    .fast-info-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        position: relative;
    }
    
    .fast-info-card.current {
        border-left: 4px solid #28a745;
        background: #f8fff9;
    }
    
    .fast-info-card.upcoming {
        border-left: 4px solid #007bff;
        background: #f8fbff;
    }
    
    .fast-info-card h4 {
        margin: 0 0 10px 0;
        font-size: 16px;
        font-weight: 600;
    }
    
    .fast-info-card .fast-status {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .fast-info-card.current .fast-status {
        background: #28a745;
        color: white;
    }
    
    .fast-info-card.upcoming .fast-status {
        background: #007bff;
        color: white;
    }
    
    .fast-info-card .fast-dates {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
    }
    
    .fast-info-card .fast-stats {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }
    
    .fast-info-card .stat-item {
        text-align: center;
    }
    
    .fast-info-card .stat-value {
        font-size: 18px;
        font-weight: bold;
        display: block;
    }
    
    .fast-info-card .stat-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }
    
    .fast-info-card .participant-count {
        text-align: center;
        padding: 8px;
        background: white;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .fast-info-card .participant-count .count {
        font-size: 24px;
        font-weight: bold;
        color: #333;
    }
    
    .fast-info-card .participant-count .label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>üìä User Engagement Dashboard</h1>
    
    <!-- Date Range Selector -->
    <div class="date-range-selector">
        <select id="dateRange" onchange="updateCharts()">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
        </select>
    </div>
    
    <!-- Key Statistics -->
    <div class="stats-grid">
        <div class="stat-card" id="stat-total-events">
            <h3>Total Events</h3>
            <p class="stat-value" id="stat-total-events-value">{{ total_events|floatformat:0 }}</p>
            <p class="stat-change" id="stat-total-events-change">Last {{ days }} days: {{ events_in_period }}</p>
        </div>

        <div class="stat-card" id="stat-fast-joins">
            <h3>Fast Joins</h3>
            <p class="stat-value" id="stat-fast-joins-value">{{ fast_joins }}</p>
            <p class="stat-change positive" id="stat-fast-joins-change">+{{ fast_joins }} this period</p>
        </div>

        <div class="stat-card" id="stat-fast-leaves">
            <h3>Fast Leaves</h3>
            <p class="stat-value" id="stat-fast-leaves-value">{{ fast_leaves }}</p>
            <p class="stat-change negative" id="stat-fast-leaves-change">-{{ fast_leaves }} this period</p>
        </div>

        <div class="stat-card" id="stat-net-growth">
            <h3>Net Growth</h3>
            <p class="stat-value" id="stat-net-growth-value">{{ net_joins }}</p>
            <p class="stat-change {% if net_joins >= 0 %}positive{% else %}negative{% endif %}" id="stat-net-growth-change">
                {% if net_joins >= 0 %}+{% endif %}{{ net_joins }} net joins
            </p>
        </div>

        <div class="stat-card" id="stat-signups">
            <h3>User Signups</h3>
            <p class="stat-value" id="stat-signups-value">{{ user_signups }}</p>
            <p class="stat-change" id="stat-signups-change">Last {{ days }} days</p>
        </div>

        <div class="stat-card" id="stat-devotionals">
            <h3>Devotional Views</h3>
            <p class="stat-value" id="stat-devotionals-value">{{ devotional_views }}</p>
            <p class="stat-change" id="stat-devotionals-change">Last {{ days }} days</p>
        </div>

        <div class="stat-card" id="stat-checklists">
            <h3>Checklist Uses</h3>
            <p class="stat-value" id="stat-checklists-value">{{ checklist_usage }}</p>
            <p class="stat-change" id="stat-checklists-change">Last {{ days }} days</p>
        </div>

        <div class="stat-card" id="stat-prayer-sets">
            <h3>Prayer Set Views</h3>
            <p class="stat-value" id="stat-prayer-sets-value">{{ prayer_set_views }}</p>
            <p class="stat-change" id="stat-prayer-sets-change">Last {{ days }} days</p>
        </div>

        <div class="stat-card" id="stat-shares">
            <h3>Shares</h3>
            <p class="stat-value" id="stat-shares-value">{{ share_events }}</p>
            <p class="stat-change" id="stat-shares-change">Last {{ days }} days</p>
        </div>
    </div>
    
    <!-- Events Over Time Chart -->
    <div class="chart-container">
        <h2 class="chart-title">üìà Events Over Time</h2>
        <div class="chart-wrapper" id="eventsOverTimeWrapper">
            <canvas id="eventsOverTimeChart"></canvas>
        </div>
    </div>

    <!-- Feature Usage Chart -->
    <div class="chart-container">
        <h2 class="chart-title">‚úÖ Feature Usage Over Time</h2>
        <div class="chart-wrapper" id="featureUsageWrapper">
            <canvas id="featureUsageChart"></canvas>
        </div>
    </div>
    
    <!-- Fast Join/Leave Trends -->
    <div class="chart-container">
        <h2 class="chart-title">üîÑ Fast Join/Leave Trends</h2>
        <div class="chart-wrapper" id="fastTrendsWrapper">
            <canvas id="fastTrendsChart"></canvas>
        </div>
    </div>
    
    <!-- Fast Join/Leave Histogram -->
    <div class="chart-container">
        <h2 class="chart-title">üìä Fast Join/Leave Histogram Over Time</h2>
        <div class="chart-wrapper" id="fastHistogramWrapper">
            <canvas id="fastHistogramChart"></canvas>
        </div>
    </div>
    
    <!-- Current/Upcoming Fast Trends -->
    <div class="chart-container">
        <h2 class="chart-title">üéØ Current & Upcoming Fast Trends</h2>
        <div class="chart-wrapper" id="currentUpcomingFastWrapper">
            <canvas id="currentUpcomingFastChart"></canvas>
        </div>
        <div id="currentUpcomingFastInfo" class="fast-info-grid">
            <!-- Fast info cards will be populated here -->
        </div>
    </div>
    
    <!-- Event Types Distribution -->
    <div class="chart-container">
        <h2 class="chart-title">üìä Event Types Distribution</h2>
        <div class="chart-wrapper">
            <canvas id="eventTypesChart"></canvas>
        </div>
    </div>
    
    <!-- Top Users Activity -->
    <div class="chart-container">
        <h2 class="chart-title">üë• Top Active Users</h2>
        <div class="chart-wrapper">
            <canvas id="topUsersChart"></canvas>
        </div>
    </div>
    
    <!-- Recent Milestones -->
    <div class="recent-milestones">
        <h2 class="chart-title">üèÜ Recent Milestones</h2>
        {% if milestones %}
            {% for milestone in milestones %}
            <div class="milestone-item">
                <div class="milestone-title">{{ milestone.title }}</div>
                <div class="milestone-time">{{ milestone.timestamp|date:"M j, Y g:i A" }}</div>
            </div>
            {% endfor %}
        {% else %}
            <p>No recent milestones</p>
        {% endif %}
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>

<!-- JSON data blobs (safe embedding) -->
{{ events_by_day|json_script:"events-by-day-data" }}
{{ events_by_type|json_script:"events-by-type-data" }}
{{ top_users|json_script:"top-users-data" }}
{{ fast_trends_data|json_script:"fast-trends-data" }}
{{ hourly_data|json_script:"hourly-data" }}
{{ current_upcoming_fast_data|json_script:"current-upcoming-fast-data" }}
{{ fast_joins|json_script:"fast-joins" }}
{{ fast_leaves|json_script:"fast-leaves" }}
{{ feature_usage_over_time|json_script:"feature-usage-data" }}
{{ user_signups_by_day|json_script:"user-signups-by-day" }}
{{ devotional_views_by_day|json_script:"devotional-views-by-day" }}
{{ checklist_usage_by_day|json_script:"checklist-usage-by-day" }}
{{ prayer_set_views_by_day|json_script:"prayer-set-views-by-day" }}
{{ share_events_by_day|json_script:"share-events-by-day" }}


<script>
// Chart configuration
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'top',
        },
        tooltip: {
            mode: 'index',
            intersect: false,
        }
    },
    scales: {
        x: {
            display: true,
            title: {
                display: true,
                text: 'Date'
            }
        },
        y: {
            display: true,
            title: {
                display: true,
                text: 'Count'
            }
        }
    }
};

// Initialize charts
let eventsOverTimeChart, fastTrendsChart, fastHistogramChart, currentUpcomingFastChart, eventTypesChart, topUsersChart, featureUsageChart;

// Data from Django context (parsed from json_script elements)
const eventsByDay = JSON.parse(document.getElementById('events-by-day-data').textContent);
const eventsByType = JSON.parse(document.getElementById('events-by-type-data').textContent);
const topUsers = JSON.parse(document.getElementById('top-users-data').textContent);
const fastTrendsData = JSON.parse(document.getElementById('fast-trends-data').textContent);
const hourlyData = JSON.parse(document.getElementById('hourly-data').textContent);
const currentUpcomingFastData = JSON.parse(document.getElementById('current-upcoming-fast-data').textContent);
const FAST_JOINS = JSON.parse(document.getElementById('fast-joins').textContent);
const FAST_LEAVES = JSON.parse(document.getElementById('fast-leaves').textContent);
const featureUsageData = JSON.parse(document.getElementById('feature-usage-data').textContent);

function initializeCharts() {
    // Events Over Time Chart
    const eventsCtx = document.getElementById('eventsOverTimeChart').getContext('2d');
    eventsOverTimeChart = new Chart(eventsCtx, {
        type: 'line',
        data: {
            labels: Object.keys(eventsByDay),
            datasets: [{
                label: 'Total Events',
                data: Object.values(eventsByDay),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Event Volume'
                }
            }
        }
    });

    // Feature Usage Chart
    const featureUsageCtx = document.getElementById('featureUsageChart').getContext('2d');
    const featureColors = [
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 99, 132, 0.8)'
    ];
    featureUsageChart = new Chart(featureUsageCtx, {
        type: 'line',
        data: {
            labels: featureUsageData.labels,
            datasets: featureUsageData.datasets.map((dataset, index) => ({
                ...dataset,
                borderColor: featureColors[index % featureColors.length],
                backgroundColor: featureColors[index % featureColors.length].replace('0.8', '0.2'),
                tension: 0.1,
                fill: true,
            })),
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Key Engagement Events Over Time'
                }
            },
        }
    });

    // Fast Trends Chart
    const fastCtx = document.getElementById('fastTrendsChart').getContext('2d');
    fastTrendsChart = new Chart(fastCtx, {
        type: 'bar',
        data: {
            labels: ['Joins', 'Leaves'],
            datasets: [{
                label: 'Fast Activity',
                data: [FAST_JOINS, FAST_LEAVES],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Fast Join vs Leave Activity (Total)'
                }
            }
        }
    });
    
    // Fast Join/Leave Histogram Chart
    const histogramCtx = document.getElementById('fastHistogramChart').getContext('2d');
    fastHistogramChart = new Chart(histogramCtx, {
        type: 'bar',
        data: {
            labels: fastTrendsData.labels,
            datasets: [
                {
                    label: 'Joins',
                    data: fastTrendsData.joins,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                },
                {
                    label: 'Leaves',
                    data: fastTrendsData.leaves,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                }
            ]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Fast Join/Leave Activity'
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Number of Users'
                    },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Current/Upcoming Fast Chart
    if (Object.keys(currentUpcomingFastData).length > 0) {
        const currentUpcomingCtx = document.getElementById('currentUpcomingFastChart').getContext('2d');
        
        // Prepare data for the chart
        const fastNames = Object.keys(currentUpcomingFastData);
        const datasets = [];
        
        fastNames.forEach((fastName, index) => {
            const fastData = currentUpcomingFastData[fastName];
            const color = fastData.is_current ? 'rgba(40, 167, 69, 0.8)' : 'rgba(0, 123, 255, 0.8)';
            const borderColor = fastData.is_current ? 'rgb(40, 167, 69)' : 'rgb(0, 123, 255)';
            
            datasets.push({
                label: `${fastName} (Joins)`,
                data: Object.values(fastData.daily_joins),
                backgroundColor: color,
                borderColor: borderColor,
                borderWidth: 1,
                stack: `stack_${index}`,
            });
            
            datasets.push({
                label: `${fastName} (Leaves)`,
                data: Object.values(fastData.daily_leaves),
                backgroundColor: color.replace('0.8', '0.4'),
                borderColor: borderColor,
                borderWidth: 1,
                stack: `stack_${index}`,
            });
        });
        
        currentUpcomingFastChart = new Chart(currentUpcomingCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(eventsByDay),
                datasets: datasets
            },
            options: {
                ...chartConfig,
                plugins: {
                    ...chartConfig.plugins,
                    title: {
                        display: true,
                        text: 'Current & Upcoming Fast Join/Leave Activity'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Number of Users'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Populate fast info cards
        populateFastInfoCards();
    } else {
        // Show message if no current/upcoming fasts
        document.getElementById('currentUpcomingFastChart').parentElement.innerHTML = 
            '<div style="text-align: center; padding: 50px; color: #666;">No current or upcoming fasts found</div>';
    }
    
    // Event Types Chart
    const typesCtx = document.getElementById('eventTypesChart').getContext('2d');
    eventTypesChart = new Chart(typesCtx, {
        type: 'doughnut',
        data: {
            labels: eventsByType.map(item => item.event_type__name),
            datasets: [{
                data: eventsByType.map(item => item.count),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)',
                    'rgba(83, 102, 255, 0.8)',
                    'rgba(78, 252, 3, 0.8)',
                    'rgba(252, 3, 244, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Event Types Distribution'
                }
            }
        }
    });
    
    // Top Users Chart
    const usersCtx = document.getElementById('topUsersChart').getContext('2d');
    topUsersChart = new Chart(usersCtx, {
        type: 'bar',
        data: {
            labels: topUsers.map(user => user.user__username),
            datasets: [{
                label: 'Events',
                data: topUsers.map(user => user.event_count),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            ...chartConfig,
            indexAxis: 'y',
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Most Active Users'
                }
            }
        }
    });
}

function populateFastInfoCards() {
    const infoContainer = document.getElementById('currentUpcomingFastInfo');
    infoContainer.innerHTML = '';
    
    Object.keys(currentUpcomingFastData).forEach(fastName => {
        const fastData = currentUpcomingFastData[fastName];
        const statusClass = fastData.is_current ? 'current' : 'upcoming';
        const statusText = fastData.is_current ? 'Current' : 'Upcoming';
        
        const card = document.createElement('div');
        card.className = `fast-info-card ${statusClass}`;
        card.innerHTML = `
            <div class="fast-status">${statusText}</div>
            <h4>${fastName}</h4>
            <div class="fast-dates">
                ${fastData.start_date} to ${fastData.end_date}
            </div>
            <div class="fast-stats">
                <div class="stat-item">
                    <span class="stat-value">${fastData.total_joins}</span>
                    <span class="stat-label">Joins</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${fastData.total_leaves}</span>
                    <span class="stat-label">Leaves</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value ${fastData.net_growth >= 0 ? 'positive' : 'negative'}">${fastData.net_growth >= 0 ? '+' : ''}${fastData.net_growth}</span>
                    <span class="stat-label">Net</span>
                </div>
            </div>
            <div class="participant-count">
                <div class="count">${fastData.participant_count}</div>
                <div class="label">Current Participants</div>
            </div>
        `;
        
        infoContainer.appendChild(card);
    });
}

function updateCharts() {
    const days = document.getElementById('dateRange').value;
    
    // Show loading state
    document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
        wrapper.innerHTML = '<div style="text-align: center; padding: 50px;">Loading...</div>';
    });
    
    // Fetch new data via AJAX
    fetch(`${window.location.pathname}data/?days=${days}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update statistics
        document.getElementById('stat-total-events-change').textContent = `Last ${days} days: ${data.events_in_period}`;
        document.getElementById('stat-fast-joins-value').textContent = data.fast_joins;
        document.getElementById('stat-fast-joins-change').textContent = `+${data.fast_joins} this period`;
        document.getElementById('stat-fast-leaves-value').textContent = data.fast_leaves;
        document.getElementById('stat-fast-leaves-change').textContent = `-${data.fast_leaves} this period`;
        document.getElementById('stat-net-growth-value').textContent = data.net_joins;

        const netChangeEl = document.getElementById('stat-net-growth-change');
        netChangeEl.textContent = `${data.net_joins >= 0 ? '+' : ''}${data.net_joins} net joins`;
        netChangeEl.className = `stat-change ${data.net_joins >= 0 ? 'positive' : 'negative'}`;

        document.getElementById('stat-signups-value').textContent = data.user_signups;
        document.getElementById('stat-devotionals-value').textContent = data.devotional_views;
        document.getElementById('stat-checklists-value').textContent = data.checklist_usage;
        document.getElementById('stat-prayer-sets-value').textContent = data.prayer_set_views;
        document.getElementById('stat-shares-value').textContent = data.share_events;

        // Recreate charts with new data
        recreateCharts(data);
    })
    .catch(error => {
        console.error('Error updating charts:', error);
        
        // Show user-friendly error message
        document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
            wrapper.innerHTML = '<div style="text-align: center; padding: 50px; color: #dc3545;">Error loading data. Please refresh the page and try again.</div>';
        });
        
        // Try to restore original charts after a delay
        setTimeout(() => {
            try {
                initializeCharts();
            } catch (e) {
                console.error('Failed to restore original charts:', e);
            }
        }, 2000);
    });
}

function recreateCharts(data) {
    // Destroy existing charts
    if (eventsOverTimeChart) eventsOverTimeChart.destroy();
    if (featureUsageChart) featureUsageChart.destroy();
    if (fastTrendsChart) fastTrendsChart.destroy();
    if (fastHistogramChart) fastHistogramChart.destroy();
    if (currentUpcomingFastChart) currentUpcomingFastChart.destroy();
    
    // Recreate chart containers using wrapper IDs
    document.getElementById('eventsOverTimeWrapper').innerHTML = '<canvas id="eventsOverTimeChart"></canvas>';
    document.getElementById('featureUsageWrapper').innerHTML = '<canvas id="featureUsageChart"></canvas>';
    document.getElementById('fastTrendsWrapper').innerHTML = '<canvas id="fastTrendsChart"></canvas>';
    document.getElementById('fastHistogramWrapper').innerHTML = '<canvas id="fastHistogramChart"></canvas>';
    document.getElementById('currentUpcomingFastWrapper').innerHTML = '<canvas id="currentUpcomingFastChart"></canvas>';
    
    // Recreate charts with new data
    const eventsCtx = document.getElementById('eventsOverTimeChart').getContext('2d');
    eventsOverTimeChart = new Chart(eventsCtx, {
        type: 'line',
        data: {
            labels: Object.keys(data.events_by_day),
            datasets: [{
                label: 'Total Events',
                data: Object.values(data.events_by_day),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Event Volume'
                }
            }
        }
    });

    const featureUsageCtx = document.getElementById('featureUsageChart').getContext('2d');
    const featureColors = [
        'rgba(54, 162, 235, 0.8)',
        'rgba(255, 205, 86, 0.8)',
        'rgba(75, 192, 192, 0.8)',
        'rgba(153, 102, 255, 0.8)',
        'rgba(255, 99, 132, 0.8)'
    ];
    featureUsageChart = new Chart(featureUsageCtx, {
        type: 'line',
        data: {
            labels: data.feature_usage_over_time.labels,
            datasets: data.feature_usage_over_time.datasets.map((dataset, index) => ({
                ...dataset,
                borderColor: featureColors[index % featureColors.length],
                backgroundColor: featureColors[index % featureColors.length].replace('0.8', '0.2'),
                tension: 0.1,
                fill: true,
            })),
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Key Engagement Events Over Time'
                }
            },
        }
    });
    
    const fastCtx = document.getElementById('fastTrendsChart').getContext('2d');
    fastTrendsChart = new Chart(fastCtx, {
        type: 'bar',
        data: {
            labels: ['Joins', 'Leaves'],
            datasets: [{
                label: 'Fast Activity',
                data: [data.fast_joins, data.fast_leaves],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Fast Join vs Leave Activity (Total)'
                }
            }
        }
    });
    
    const histogramCtx = document.getElementById('fastHistogramChart').getContext('2d');
    fastHistogramChart = new Chart(histogramCtx, {
        type: 'bar',
        data: {
            labels: data.fast_trends_data.labels,
            datasets: [
                {
                    label: 'Joins',
                    data: data.fast_trends_data.joins,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                },
                {
                    label: 'Leaves',
                    data: data.fast_trends_data.leaves,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                }
            ]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Fast Join/Leave Activity'
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Number of Users'
                    },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Recreate Current/Upcoming Fast Chart
    if (data.current_upcoming_fast_data && Object.keys(data.current_upcoming_fast_data).length > 0) {
        const currentUpcomingCtx = document.getElementById('currentUpcomingFastChart').getContext('2d');
        
        // Prepare data for the chart
        const fastNames = Object.keys(data.current_upcoming_fast_data);
        const datasets = [];
        
        fastNames.forEach((fastName, index) => {
            const fastData = data.current_upcoming_fast_data[fastName];
            const color = fastData.is_current ? 'rgba(40, 167, 69, 0.8)' : 'rgba(0, 123, 255, 0.8)';
            const borderColor = fastData.is_current ? 'rgb(40, 167, 69)' : 'rgb(0, 123, 255)';
            
            datasets.push({
                label: `${fastName} (Joins)`,
                data: Object.values(fastData.daily_joins),
                backgroundColor: color,
                borderColor: borderColor,
                borderWidth: 1,
                stack: `stack_${index}`,
            });
            
            datasets.push({
                label: `${fastName} (Leaves)`,
                data: Object.values(fastData.daily_leaves),
                backgroundColor: color.replace('0.8', '0.4'),
                borderColor: borderColor,
                borderWidth: 1,
                stack: `stack_${index}`,
            });
        });
        
        currentUpcomingFastChart = new Chart(currentUpcomingCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(data.events_by_day),
                datasets: datasets
            },
            options: {
                ...chartConfig,
                plugins: {
                    ...chartConfig.plugins,
                    title: {
                        display: true,
                        text: 'Current & Upcoming Fast Join/Leave Activity'
                    }
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Number of Users'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Update fast info cards
        updateFastInfoCards(data.current_upcoming_fast_data);
    }
}

function updateFastInfoCards(fastData) {
    const infoContainer = document.getElementById('currentUpcomingFastInfo');
    infoContainer.innerHTML = '';
    
    Object.keys(fastData).forEach(fastName => {
        const fast = fastData[fastName];
        const statusClass = fast.is_current ? 'current' : 'upcoming';
        const statusText = fast.is_current ? 'Current' : 'Upcoming';
        
        const card = document.createElement('div');
        card.className = `fast-info-card ${statusClass}`;
        card.innerHTML = `
            <div class="fast-status">${statusText}</div>
            <h4>${fastName}</h4>
            <div class="fast-dates">
                ${fast.start_date} to ${fast.end_date}
            </div>
            <div class="fast-stats">
                <div class="stat-item">
                    <span class="stat-value">${fast.total_joins}</span>
                    <span class="stat-label">Joins</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${fast.total_leaves}</span>
                    <span class="stat-label">Leaves</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value ${fast.net_growth >= 0 ? 'positive' : 'negative'}">${fast.net_growth >= 0 ? '+' : ''}${fast.net_growth}</span>
                    <span class="stat-label">Net</span>
                </div>
            </div>
            <div class="participant-count">
                <div class="count">${fast.participant_count}</div>
                <div class="label">Current Participants</div>
            </div>
        `;
        
        infoContainer.appendChild(card);
    });
}

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});
</script>
{% endblock %} 