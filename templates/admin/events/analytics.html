{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    .analytics-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-card h3 {
        margin: 0 0 10px 0;
        color: #666;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-value {
        font-size: 32px;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    
    .stat-change {
        font-size: 14px;
        margin-top: 5px;
    }
    
    .stat-change.positive {
        color: #28a745;
    }
    
    .stat-change.negative {
        color: #dc3545;
    }
    
    .chart-container {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-title {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 18px;
        font-weight: 600;
    }
    
    .chart-wrapper {
        position: relative;
        height: 400px;
    }
    
    .recent-milestones {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .milestone-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    
    .milestone-item:last-child {
        border-bottom: none;
    }
    
    .milestone-title {
        font-weight: 600;
        color: #333;
    }
    
    .milestone-time {
        color: #666;
        font-size: 12px;
    }
    
    .date-range-selector {
        margin-bottom: 20px;
        text-align: right;
    }
    
    .date-range-selector select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>üìä Events Analytics Dashboard</h1>
    
    <!-- Date Range Selector -->
    <div class="date-range-selector">
        <select id="dateRange" onchange="updateCharts()">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
        </select>
    </div>
    
    <!-- Key Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Events</h3>
            <p class="stat-value">{{ total_events|floatformat:0 }}</p>
            <p class="stat-change">Last {{ days }} days: {{ events_in_period }}</p>
        </div>
        
        <div class="stat-card">
            <h3>Fast Joins</h3>
            <p class="stat-value">{{ fast_joins }}</p>
            <p class="stat-change positive">+{{ fast_joins }} this period</p>
        </div>
        
        <div class="stat-card">
            <h3>Fast Leaves</h3>
            <p class="stat-value">{{ fast_leaves }}</p>
            <p class="stat-change negative">-{{ fast_leaves }} this period</p>
        </div>
        
        <div class="stat-card">
            <h3>Net Growth</h3>
            <p class="stat-value">{{ net_joins }}</p>
            <p class="stat-change {% if net_joins >= 0 %}positive{% else %}negative{% endif %}">
                {% if net_joins >= 0 %}+{% endif %}{{ net_joins }} net joins
            </p>
        </div>
    </div>
    
    <!-- Events Over Time Chart -->
    <div class="chart-container">
        <h2 class="chart-title">üìà Events Over Time</h2>
        <div class="chart-wrapper">
            <canvas id="eventsOverTimeChart"></canvas>
        </div>
    </div>
    
    <!-- Fast Join/Leave Trends -->
    <div class="chart-container">
        <h2 class="chart-title">üîÑ Fast Join/Leave Trends</h2>
        <div class="chart-wrapper">
            <canvas id="fastTrendsChart"></canvas>
        </div>
    </div>
    
    <!-- Fast Join/Leave Histogram -->
    <div class="chart-container">
        <h2 class="chart-title">üìä Fast Join/Leave Histogram Over Time</h2>
        <div class="chart-wrapper">
            <canvas id="fastHistogramChart"></canvas>
        </div>
    </div>
    
    <!-- Event Types Distribution -->
    <div class="chart-container">
        <h2 class="chart-title">üìä Event Types Distribution</h2>
        <div class="chart-wrapper">
            <canvas id="eventTypesChart"></canvas>
        </div>
    </div>
    
    <!-- Top Users Activity -->
    <div class="chart-container">
        <h2 class="chart-title">üë• Top Active Users</h2>
        <div class="chart-wrapper">
            <canvas id="topUsersChart"></canvas>
        </div>
    </div>
    
    <!-- Recent Milestones -->
    <div class="recent-milestones">
        <h2 class="chart-title">üèÜ Recent Milestones</h2>
        {% if milestones %}
            {% for milestone in milestones %}
            <div class="milestone-item">
                <div class="milestone-title">{{ milestone.title }}</div>
                <div class="milestone-time">{{ milestone.timestamp|date:"M j, Y g:i A" }}</div>
            </div>
            {% endfor %}
        {% else %}
            <p>No recent milestones</p>
        {% endif %}
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart configuration
const chartConfig = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
        legend: {
            position: 'top',
        },
        tooltip: {
            mode: 'index',
            intersect: false,
        }
    },
    scales: {
        x: {
            display: true,
            title: {
                display: true,
                text: 'Date'
            }
        },
        y: {
            display: true,
            title: {
                display: true,
                text: 'Count'
            }
        }
    }
};

// Initialize charts
let eventsOverTimeChart, fastTrendsChart, fastHistogramChart, eventTypesChart, topUsersChart;

// Data from Django context
const eventsByDay = {{ events_by_day|safe }};
const eventsByType = {{ events_by_type|safe }};
const topUsers = {{ top_users|safe }};
const fastTrendsData = {{ fast_trends_data|safe }};
const hourlyData = {{ hourly_data|safe }};

function initializeCharts() {
    // Events Over Time Chart
    const eventsCtx = document.getElementById('eventsOverTimeChart').getContext('2d');
    eventsOverTimeChart = new Chart(eventsCtx, {
        type: 'line',
        data: {
            labels: Object.keys(eventsByDay),
            datasets: [{
                label: 'Total Events',
                data: Object.values(eventsByDay),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Event Volume'
                }
            }
        }
    });
    
    // Fast Trends Chart
    const fastCtx = document.getElementById('fastTrendsChart').getContext('2d');
    fastTrendsChart = new Chart(fastCtx, {
        type: 'bar',
        data: {
            labels: ['Joins', 'Leaves'],
            datasets: [{
                label: 'Fast Activity',
                data: [{{ fast_joins }}, {{ fast_leaves }}],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Fast Join vs Leave Activity (Total)'
                }
            }
        }
    });
    
    // Fast Join/Leave Histogram Chart
    const histogramCtx = document.getElementById('fastHistogramChart').getContext('2d');
    fastHistogramChart = new Chart(histogramCtx, {
        type: 'bar',
        data: {
            labels: fastTrendsData.labels,
            datasets: [
                {
                    label: 'Joins',
                    data: fastTrendsData.joins,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                },
                {
                    label: 'Leaves',
                    data: fastTrendsData.leaves,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                }
            ]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Fast Join/Leave Activity'
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Number of Users'
                    },
                    beginAtZero: true
                }
            }
        }
    });
    
    // Event Types Chart
    const typesCtx = document.getElementById('eventTypesChart').getContext('2d');
    eventTypesChart = new Chart(typesCtx, {
        type: 'doughnut',
        data: {
            labels: eventsByType.map(item => item.event_type__name),
            datasets: [{
                data: eventsByType.map(item => item.count),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)',
                    'rgba(255, 159, 64, 0.8)',
                    'rgba(199, 199, 199, 0.8)',
                    'rgba(83, 102, 255, 0.8)',
                    'rgba(78, 252, 3, 0.8)',
                    'rgba(252, 3, 244, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                title: {
                    display: true,
                    text: 'Event Types Distribution'
                }
            }
        }
    });
    
    // Top Users Chart
    const usersCtx = document.getElementById('topUsersChart').getContext('2d');
    topUsersChart = new Chart(usersCtx, {
        type: 'horizontalBar',
        data: {
            labels: topUsers.map(user => user.user__username),
            datasets: [{
                label: 'Events',
                data: topUsers.map(user => user.event_count),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgb(54, 162, 235)',
                borderWidth: 1
            }]
        },
        options: {
            ...chartConfig,
            indexAxis: 'y',
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Most Active Users'
                }
            }
        }
    });
}

function updateCharts() {
    const days = document.getElementById('dateRange').value;
    
    // Show loading state
    document.querySelectorAll('.chart-wrapper').forEach(wrapper => {
        wrapper.innerHTML = '<div style="text-align: center; padding: 50px;">Loading...</div>';
    });
    
    // Fetch new data via AJAX
    fetch(`?days=${days}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        // Update statistics
        document.querySelector('.stat-card:nth-child(1) .stat-change').textContent = `Last ${days} days: ${data.events_in_period}`;
        document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = data.fast_joins;
        document.querySelector('.stat-card:nth-child(2) .stat-change').textContent = `+${data.fast_joins} this period`;
        document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = data.fast_leaves;
        document.querySelector('.stat-card:nth-child(3) .stat-change').textContent = `-${data.fast_leaves} this period`;
        document.querySelector('.stat-card:nth-child(4) .stat-value').textContent = data.net_joins;
        
        const netChangeEl = document.querySelector('.stat-card:nth-child(4) .stat-change');
        netChangeEl.textContent = `${data.net_joins >= 0 ? '+' : ''}${data.net_joins} net joins`;
        netChangeEl.className = `stat-change ${data.net_joins >= 0 ? 'positive' : 'negative'}`;
        
        // Recreate charts with new data
        recreateCharts(data);
    })
    .catch(error => {
        console.error('Error updating charts:', error);
        // Restore original charts on error
        initializeCharts();
    });
}

function recreateCharts(data) {
    // Destroy existing charts
    if (eventsOverTimeChart) eventsOverTimeChart.destroy();
    if (fastTrendsChart) fastTrendsChart.destroy();
    if (fastHistogramChart) fastHistogramChart.destroy();
    
    // Recreate chart containers
    document.getElementById('eventsOverTimeChart').parentElement.innerHTML = '<canvas id="eventsOverTimeChart"></canvas>';
    document.getElementById('fastTrendsChart').parentElement.innerHTML = '<canvas id="fastTrendsChart"></canvas>';
    document.getElementById('fastHistogramChart').parentElement.innerHTML = '<canvas id="fastHistogramChart"></canvas>';
    
    // Recreate charts with new data
    const eventsCtx = document.getElementById('eventsOverTimeChart').getContext('2d');
    eventsOverTimeChart = new Chart(eventsCtx, {
        type: 'line',
        data: {
            labels: Object.keys(data.events_by_day),
            datasets: [{
                label: 'Total Events',
                data: Object.values(data.events_by_day),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Event Volume'
                }
            }
        }
    });
    
    const fastCtx = document.getElementById('fastTrendsChart').getContext('2d');
    fastTrendsChart = new Chart(fastCtx, {
        type: 'bar',
        data: {
            labels: ['Joins', 'Leaves'],
            datasets: [{
                label: 'Fast Activity',
                data: [data.fast_joins, data.fast_leaves],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(255, 99, 132, 0.8)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(255, 99, 132)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Fast Join vs Leave Activity (Total)'
                }
            }
        }
    });
    
    const histogramCtx = document.getElementById('fastHistogramChart').getContext('2d');
    fastHistogramChart = new Chart(histogramCtx, {
        type: 'bar',
        data: {
            labels: data.fast_trends_data.labels,
            datasets: [
                {
                    label: 'Joins',
                    data: data.fast_trends_data.joins,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)',
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                },
                {
                    label: 'Leaves',
                    data: data.fast_trends_data.leaves,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                    borderColor: 'rgb(255, 99, 132)',
                    borderWidth: 1,
                    stack: 'Stack 0',
                }
            ]
        },
        options: {
            ...chartConfig,
            plugins: {
                ...chartConfig.plugins,
                title: {
                    display: true,
                    text: 'Daily Fast Join/Leave Activity'
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Number of Users'
                    },
                    beginAtZero: true
                }
            }
        }
    });
}

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});
</script>
{% endblock %} 