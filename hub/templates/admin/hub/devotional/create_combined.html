{% extends "admin/base_site.html" %}
{% load i18n admin_urls %}

{% block extrahead %}
{{ block.super }}
{{ form.media }}
<style>
  .combined-form fieldset {
    border: 1px solid #ddd;
    padding: 15px 20px;
    margin-bottom: 20px;
    border-radius: 4px;
  }
  .combined-form legend {
    font-weight: bold;
    font-size: 1.1em;
    padding: 0 8px;
  }
  .side-by-side {
    display: flex;
    gap: 20px;
  }
  .side-by-side > .column {
    flex: 1;
  }
  .form-row {
    margin-bottom: 12px;
  }
  .form-row label {
    display: block;
    font-weight: bold;
    margin-bottom: 4px;
  }
  .form-row .helptext {
    color: #666;
    font-size: 0.85em;
  }
  .form-row input[type="text"],
  .form-row input[type="number"],
  .form-row input[type="date"],
  .form-row select,
  .form-row textarea {
    width: 100%;
    padding: 6px 8px;
  }
  .errorlist {
    color: #ba2121;
    list-style: none;
    padding: 0;
    margin: 4px 0 0;
  }
  .new-video-fields { margin-top: 10px; }
  .lang-checkbox { display: inline-block; margin-right: 15px; }
  .lang-checkbox label { font-weight: normal; cursor: pointer; }
</style>
{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% translate 'Home' %}</a>
  &rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
  &rsaquo; <a href="{% url opts|admin_urlname:'changelist' %}">{{ opts.verbose_name_plural|capfirst }}</a>
  &rsaquo; {% translate "Create combined devotional" %}
</div>
{% endblock %}

{% block content %}
<form action="" method="post" enctype="multipart/form-data" class="combined-form">
  {% csrf_token %}

  {% if form.non_field_errors %}
    <div class="errornote">
      {{ form.non_field_errors }}
    </div>
  {% endif %}

  {# --- Date, Fast & Order (shared) --- #}
  <fieldset>
    <legend>Date, Fast &amp; Order</legend>
    <div class="form-row">
      <label for="{{ form.date.id_for_label }}">Date:</label>
      {{ form.date }}
      {% if form.date.help_text %}<p class="helptext">{{ form.date.help_text }}</p>{% endif %}
      {{ form.date.errors }}
    </div>
    <div class="form-row">
      <label for="{{ form.fast.id_for_label }}">Fast:</label>
      {{ form.fast }}
      <p class="helptext" id="fast-auto-status" style="display:none;"></p>
      {% if form.fast.help_text %}<p class="helptext">{{ form.fast.help_text }}</p>{% endif %}
      {{ form.fast.errors }}
    </div>
    <div class="form-row">
      <label for="{{ form.order.id_for_label }}">Order:</label>
      {{ form.order }}
      {% if form.order.help_text %}<p class="helptext">{{ form.order.help_text }}</p>{% endif %}
      {{ form.order.errors }}
    </div>
  </fieldset>

  {# --- Language selection --- #}
  <fieldset>
    <legend>Languages</legend>
    <p class="helptext">English is always included. Select additional languages as needed.</p>
    {% for lang in language_fields %}
      <span class="lang-checkbox">
        <label>
          <input type="checkbox" name="languages" value="{{ lang.code }}"
            class="lang-toggle"
            data-lang="{{ lang.code }}"
            {% if lang.selected %}checked{% endif %}
            {% if lang.required %}disabled{% endif %}>
          {{ lang.name }}
        </label>
      </span>
    {% endfor %}
    {# Disabled checkboxes don't submit; hidden input ensures EN is always included #}
    <input type="hidden" name="languages" value="en">
    {{ form.languages.errors }}
  </fieldset>

  {# --- Videos (dynamic columns per language) --- #}
  <fieldset>
    <legend>Videos</legend>
    <div class="side-by-side">
      {% for lang in language_fields %}
      <div class="column lang-section" data-lang="{{ lang.code }}"
           {% if not lang.selected %}style="display:none;"{% endif %}>
        <h3>{{ lang.name }} Video</h3>
        <div class="form-row">
          <label for="{{ lang.existing_video.id_for_label }}">{{ lang.existing_video.label }}:</label>
          {{ lang.existing_video }}
          {{ lang.existing_video.errors }}
        </div>
        <div class="form-row">
          <label><input type="checkbox" class="toggle-new-video" data-lang="{{ lang.code }}" checked> Create new video</label>
        </div>
        <div class="new-video-fields" id="new-video-{{ lang.code }}">
          <div class="form-row">
            <label for="{{ lang.video_title.id_for_label }}">{{ lang.video_title.label }}:</label>
            {{ lang.video_title }}
            {{ lang.video_title.errors }}
          </div>
          <div class="form-row">
            <label for="{{ lang.video_description.id_for_label }}">{{ lang.video_description.label }}:</label>
            {{ lang.video_description }}
            {{ lang.video_description.errors }}
          </div>
          <div class="form-row">
            <label for="{{ lang.video_file.id_for_label }}">{{ lang.video_file.label }}:</label>
            {{ lang.video_file }}
            {% if lang.video_file.help_text %}<p class="helptext">{{ lang.video_file.help_text }}</p>{% endif %}
            {{ lang.video_file.errors }}
          </div>
          <div class="form-row">
            <label for="{{ lang.video_thumbnail.id_for_label }}">{{ lang.video_thumbnail.label }}:</label>
            {{ lang.video_thumbnail }}
            {{ lang.video_thumbnail.errors }}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </fieldset>

  {# --- Devotional descriptions (dynamic columns per language) --- #}
  <fieldset>
    <legend>Devotional Descriptions</legend>
    <div class="side-by-side">
      {% for lang in language_fields %}
      <div class="column lang-section" data-lang="{{ lang.code }}"
           {% if not lang.selected %}style="display:none;"{% endif %}>
        <div class="form-row">
          <label for="{{ lang.devotional_description.id_for_label }}">{{ lang.devotional_description.label }}:</label>
          {{ lang.devotional_description }}
          {{ lang.devotional_description.errors }}
        </div>
      </div>
      {% endfor %}
    </div>
  </fieldset>

  <input type="submit" value="Create devotionals" class="default">
</form>

<script>
(function() {
  // --- Language toggle: show/hide per-language sections ---
  document.querySelectorAll('.lang-toggle').forEach(function(toggle) {
    toggle.addEventListener('change', function() {
      var lang = this.dataset.lang;
      var sections = document.querySelectorAll('.lang-section[data-lang="' + lang + '"]');
      sections.forEach(function(section) {
        section.style.display = toggle.checked ? '' : 'none';
      });
    });
  });

  // --- Toggle new-video / existing-video per language ---
  document.querySelectorAll('.toggle-new-video').forEach(function(toggle) {
    var lang = toggle.dataset.lang;
    var newFields = document.getElementById('new-video-' + lang);
    var existingSelect = document.getElementById('id_existing_video_' + lang);

    function update() {
      var createNew = toggle.checked;
      newFields.style.display = createNew ? '' : 'none';
      if (existingSelect) {
        existingSelect.disabled = createNew;
        if (createNew) existingSelect.value = '';
      }
    }

    toggle.addEventListener('change', update);

    // If existing video has a value on page load (e.g. after validation error), uncheck toggle
    if (existingSelect && existingSelect.value) {
      toggle.checked = false;
    }
    update();
  });

  // --- Auto-fill Fast from Date ---
  var dateInput = document.getElementById('id_date');
  var fastSelect = document.getElementById('id_fast');
  var statusEl = document.getElementById('fast-auto-status');

  if (dateInput && fastSelect) {
    dateInput.addEventListener('change', function() {
      var dateVal = dateInput.value;
      if (!dateVal) {
        statusEl.style.display = 'none';
        return;
      }
      fetch("{% url 'admin:lookup-fast-by-date' %}?date=" + encodeURIComponent(dateVal))
        .then(function(resp) { return resp.json(); })
        .then(function(data) {
          if (data.fasts && data.fasts.length > 0) {
            var fastId = String(data.fasts[0].id);
            for (var i = 0; i < fastSelect.options.length; i++) {
              if (fastSelect.options[i].value === fastId) {
                fastSelect.value = fastId;
                statusEl.textContent = 'Auto-filled from existing day for ' + dateVal + '.';
                statusEl.style.display = '';
                statusEl.style.color = '#28a745';
                return;
              }
            }
            statusEl.textContent = 'Found fast "' + data.fasts[0].name + '" but it is not in the dropdown.';
            statusEl.style.display = '';
            statusEl.style.color = '#c00';
          } else {
            statusEl.textContent = 'No existing day found for ' + dateVal + '. Please select a fast manually.';
            statusEl.style.display = '';
            statusEl.style.color = '#666';
          }
        })
        .catch(function() {
          statusEl.style.display = 'none';
        });
    });
  }
})();
</script>
{% endblock %}
